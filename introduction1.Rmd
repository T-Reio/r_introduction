---
title: "An Introduction to R"
author:
  - "Reio Tanji"
  - "Osaka Univ., Graduate School of Econ."
date: "April, 2022"
output: 
  revealjs::revealjs_presentation:
    self_contained: FALSE
    theme: serif
    css: introduction.css
    reveal_plugins: ["menu"]
    reveal_options:
      menu:
        numbers: TRUE
  html_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

# R言語を使う

- R言語とは？
- Rでできること
  - 研究・分析のフロー
- R言語の基本構造

## R言語とは？

- "*R is a free software environment for statistical computing and graphics*"<br>(from [The R Project for Statistical Computing](https://www.r-project.org/))

    - 統計計算、グラフ作成を行うことができる無料のツール
    - データの収集、管理、分析から結果の出力・プレゼンテーションの作成までを一つの言語で行うことも出来る
    - この資料もRを使って作成(R Markdown)

- 目標

    - 今回は、Rの基本的な操作方法を学習した上で、論文執筆の上で最低限必要なアウトプットのための技術習得をめざす

## Rでできること

- データの操作

    - データの取得：デフォルトのデータセット、csvファイル等の読み込み
    - データの整理：必要な情報の抽出、データの変形、新たな変数の作成と保存

- データの要約・可視化

    - 基本統計量の作成
    - 変数間の関係を視覚的に描写：graphics, ggplot2

- データ分析

    - 計量経済学・統計学で用いられる様々な手法の実装
    - 結果の出力

- レポートの作成

    - 分析結果をスライドにして報告 RMarkdown

        - Word, Powerpoint形式でファイルを出力

    - 出力の保存や体裁を整える手間が削減できる
    
## データの操作

- 利用するデータの読み込み

```{r, out.width="70%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/data_rei.png")
```

- データを加工する

  - 欲しい行だけ抜き出す、欲しい列だけ抜き出す
  - 元データの情報を使って、分析のための新しい変数を作る
  - 例えば、人口50万人以上の都市に1, それ以外に0を入れる「大都市ダミー」を作成する


## データの要約・可視化

- 要約統計量の作成

```{r, out.width="80%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/summary_ex.png")
```

- データの概要を示す：各変数の平均・標準偏差など
- 性別ごと、年代ごとなど、カテゴリで分けて表示する場合も
- 可視化できるデータは可視化すると分かりやすい

## 可視化されたデータの例

```{r, warning=FALSE, fig.align='center', fig.height=4, fig.width=6}
df <- palmerpenguins::penguins
ggplot2::ggplot(df) +
  ggplot2::aes(x = body_mass_g, y = bill_length_mm, colour = species) +
  ggplot2::geom_point() +
  ggplot2::scale_colour_viridis_d()
```


## データ分析

$$\text{weight}_{i} = \text{flipperSize}_i + \text{Spiecies}_i + u_i$$
  
```{r, out.extra="70%"}
df %>%
  lm(formula = body_mass_g ~ flipper_length_mm + species, data = .) %>%
  summary()
```

## レポートの作成

- Rで行った分析の結果を、Wordやパワーポイントにまとめて出力、保存できる
- 習熟度によってはそのまま論文を書くことも可能、そこまでいかずとも色々と手間が省けて便利

## おまけ：データの取得

- Rでは様々なデータセットを
- ウェブサイトから情報を収集して分析を行いたい場合がある
- Rのコードからウェブサイトを開き、中の要素を分析に使えるデータセットとして出力することができる

## 基本構造

- 基本的には、というか全ての命令は

    - Rに命令を投げる→命令に従って計算(描画・読み込みなど)を行う

    - 必要であればアウトプットを返す

    の繰り返し

- エレベーターの3階ボタンを押す→3階に向かう、ドアを開ける

    - ボタンを押すエネルギーでエレベータが動いているわけではない
    - ワイヤーをどれだけ巻き取ればどれだけ上昇・下降するのか、ドアを開けるためにどの部分にどれだけ力を加えればいいのか、が3回ボタンを押したときに発せられる命令として書かれている

- この命令を一つ一つ書く作業を行う

## 参考

- 立命館大：森先生のサイトが大変勉強になります
  - [卒業論文のためのR入門](https://tomoecon.github.io/R_for_graduate_thesis/)
- その他、分からないことはgoogleする力を付けましょう
  - "r (関数名)"とかで大体載ってます
  - GitHubなどで自身の作成したライブラリや関数の使い方などを解説しているものも多数存在
- [R Tips](http://cse.naro.affrc.go.jp/takezawa/r-tips/r.html)
- [RjpWiki](http://www.okadajp.org/RWiki/)

## その他

- ショートカット：マウスを極力使わない→作業効率の改善
- 共通の操作
  - Ctrl + X, C, V：順に切り取り・コピー・貼り付け
  - Ctrl + A：全範囲を選択
  - Ctrl + Z, Y：操作を戻す・進める
  - Ctrl + F：ウィンドウ内検索
  - Ctrl + S：(上書き)保存
- R Studio内の操作
  - Ctrl + Shift + N：新しいスクリプトを開く
  - Ctrl + O：保存したファイルを開く(Studio以外でもだいたい使える)
  - Ctrl + W：タブを閉じる(Chromeとかブラウザも同じ)
  - Ctrl + Q：R Studioの終了
- Word, PowerPoint, Excelを扱うときもできるだけマウスを使わない
  - 慣れると作業効率がだいぶ変わる

# Setup

- Rでの作業に使うもの
  - 開発環境とは、R Studioのすすめ
- インストール
- 基本操作画面

## Rでの作業に必要なもの

- **R言語**と**R Studio**の2つをインストール
  - R言語をスムーズに利用するためのツール：開発環境がRStudio
  - デフォルトでR GUI と呼ばれる開発環境がインストールされるが、色々な理由から使いづらい
    - 罫線の引いてあるノートに書くか、自由帳に書くかみたいな違い
    - 最終的にR言語で命令を書くのは同じ
  - その他にも Jupyter Notebook, VS Code, Atomなど様々な開発環境があるので、好きなものを使えばよい
- R Studio Cloud: クラウド上でR Studioの機能を利用できるサービス
  - 無料の場合は月あたりの利用時間が制限されるなど問題はあるが、特に自前PCのない人は検討してみてもよいかも
  
## RとR Studio

```{r, out.width="95%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/r_structure.png")
```

## CSVファイルと Microsoft Excel

- csvファイル：データをカンマ(,)と改行を使って表現するテキストデータ
  - Officeが入っているPCでは、拡張子「.csv」のファイルはExcelで開かれるが、別にExcel以外では使えないわけではない
- これを一般的なテキストエディタで開くとこうなる

## インストール

[Rのダウンロードはここから](https://cran.ism.ac.jp/)

[RStudio Desktop](https://www.rstudio.com/products/rstudio/download/#download)

- 【定期】詰まったら4回生に訊いて下さい
- それぞれ必ず最新バージョンをダウンロードすること
  - 定期的にアップデートしておくのがおすすめ、たまに関数の仕様とかが大幅に変わる
  - たぶんいないと思いますが、Ver.4.0.0以前のものを使用している4回生はインストールし直して下さい
- Cドライブに日本語フォントが含まれている人
  - C:/Users/.../...のところ
  - ファイルの保存などする際に非常に面倒なことになります
  - 特に動作で問題が出なければいいですが、コードの実行中に止まるなどあれば相談して下さい
  - 今から買う人は絶対に日本語フォントを入れないようにしましょう、一生

## R Studioの基本画面

- 4つの画面 (Pane)が表示される: コードを入力するのは Source, Consoleの2つ
  - Source：Rスクリプトなどを編集・保存
  - Console：実行するコードを直接入力・実行できる。
  - 右側の Pane では読み込んだデータフレームやオブジェクトの定義確認、図表出力のチェックなどが行える
  
```{r, out.width="77%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/rstudio_appearance.png")
```

## 触ってみる

- コンソールに適当なコードを入力してみよう

```{r}
1 + 3 + 5
```

- コンソールではEnter, ソース(スクリプト)ではCtrl + Enterでコードを実行する
- 出力は>に続いて出る(文字色が変わるので分かりやすいはず)
- このスライド上では、コード、出力を四角囲みで、うち出力を##に続く形で表現する

# プロジェクトの作成、バージョン管理

- ディレクトリとは
- ディレクトリの構造
- フォルダの共有方法
- R Studioでプロジェクトを作成する方法

## ディレクトリ

- ファイルやフォルダを参照する際に示すPC内の**住所**
  - C:/...がそれ
  - 全てが同じ階層に入っているのは作業こそ楽だが、自分で参照するときに探すのが面倒
    - ゼミ論文に使うdata.csvというファイルを保存→他の講義で同じ名前のファイルを受け取る→後から見たらどれがどれだか分からなくなる
- 整理の方法: 作業やファイルの種類ごとにフォルダを作り、異なる系統のファイルを識別
  - 何をする作業のフォルダなのか？
  - データの種類：整理する前の生データなのか、そのまま分析に使えるデータなのか？
  - アウトプット: 分析結果、図表
- R Studioでは、特定のフォルダを「プロジェクト」として扱い、「誰のPCでも動くコード」を作ることができる

## ディレクトリの構造

```{r, out.width="77%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/folder.jpg")
```

- 使いやすいフォルダの作成
  - 各自のPCで"r_intro"フォルダを作り、必要なファイルをしまっておけば、誰が書いたコードでも個々人がPCで再現できる環境に
  - フォルダ名は\\(バックスラッシュ, ￥)を/ (スラッシュ)に変えて記述
  
## フォルダ

```{r, out.width="95%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/directory_system.png")
```

## フォルダ (cont'd)

```{r, out.width="95%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/directory_system2.png")
```

## 拡張子

- PC上で扱うファイルには、それがどのアプリケーション(ソフト)で利用するものなのかがPC側に伝わる印が付いていることが多い：拡張子
  - 例えば.csvはMicrosoft Excelで開くと決めている(既定のアプリ)
  - .RはRスクリプトを表すことが分かるのでR StudioやR GUI、.htmlはブラウザで開く
  
## フォルダの共有方法

- フォルダの共有：データや書いたスクリプトを共有する
  - 何度も修正を加えたり、作った図表を共有するのはめんどい
  - 結果、分析をした人がスライドも全部作る…になりがち
- フォルダをメンバー間で同期する(共有する)ツールをマスターすると、グループでの作業が楽になる
  - [Dropbox](https://www.dropbox.com/)
  - [GitHub](https://github.com/)
  
- 特にGitHubはRStudioと直接連携して簡単にクラウド共有・共有したデータのダウンロードも可能なので非常に便利
  - データをオープンで保有することになるので、扱うデータの種類によっては注意が必要

## フォルダの共有方法(cont'd)
  
- Google Driveを使う方法もあり
  - Google Document, Spreadsheet, Slides を使った論文共同執筆はべんり
  - OfficeのWord, Excel, Powerpointに比べると機能がかなり制限される弱点
  - 特にスライド作成に関しては不便なポイントが多いかも
- 文面はGoogle Driveで共有しながら作成しつつ、体裁を適宜Wordにダウンロードするなどして修正する必要がある

## プロジェクトの作り方

```{r, out.width="95%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/create_repository.png")
```

## プロジェクトの作り方(cont'd)

```{r, out.width="95%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figs/create_repository2.png")
```

# 基本操作

## スクリプトの作成、演算子

- "r_introduction"というプロジェクトを作成、事前に配布したファイルの中身をその中に展開

- R Studioを開く
  - R Consoleにコードを直接入力してEnter、もしくはRスクリプトにコードを記述してCtrl + Enterで実行
  - RスクリプトはCtrl+Shift+Nで作成可能
  - Ctrl + Sで保存、上書き保存

```{r K3}
1 + 2 * (3 / 4) # 掛け算は*で
```

- その他、基本的な演算記号は[R-Tips](http://cse.naro.affrc.go.jp/takezawa/r-tips/r.html)などを参照せよ

## 変数の型

- 数値だけでなく、文字も扱うことができる
  - 何を使っても良いわけではない：Excelも一緒
    - 電話番号を入力したのに頭の0が消える→Excelが電話番号を数値として認識してしまっているから
    - Excelの場合、数値の形式を標準(Excelに自己判断させる)から文字列に変更することで対処
  - 文字列を""で囲って表記することで、それが文字列であることをRに伝えることができる
  - class関数(関数については後述)を使うと、その値の型が分かる
```{r class}
class(3.14) # class()はその変数の型を返す関数
class('1.90') # 文字列 character と判定される
```

## 変数の型(cont'd)

- numeric, integerは足し引きできるが、characterはできない
  - integerは整数
```{r character, eval=FALSE}
"1" + "2" # エラーが出る
```

```{r}
class(11L) # 整数の後ろに"L"を付けると整数として認識される
```
## 変数の型(cont'd)

- factor
  - 順序が付いた文字列
  - factor()で定義
  - アルファベット順や数字順以外の方法で並べたい場合に使う
  - まあ使うときにやればいいとおもいます
```{r}
factor(c("January", "February", "March", "April")) # アルファベット順に並んでしまう
factor(c("January", "February", "March", "April"), 
       levels = c("January", "February", "March", "April"))
```
  

## オブジェクト

- では""で囲わずに入力した文字列はどう認識されるのか？
  1. 特定の値と結びついている
    - `pi`: 円周率
  2. 自信が定義した任意の値が格納されている
    - オブジェクト: 数値やベクトル、データフレームやリストを格納、R Studioでは右上のEnvironmentタブに定義が表示される
    - 回帰分析などの計算結果を格納することも可能
    - `<-` を使って適当な値を定義する
    - `wani <- 3`：waniというオブジェクトに値3を格納
- R Studioでは Environmentに定義したオブジェクトの中身が表示される    

## オブジェクトの定義
```{r}
pi # デフォルトで円周率が格納されている
value <- 8 # valueという文字列に8を代入
value + 10 # 今valueの値は8なので、8 + 10を計算した結果を返してくれる
```

## ベクトル

- ベクトル：複数の要素を含む列
  - `c(a, b, c, ...)`で定義される
  - 文字列など、他の数値型を利用してもOK
```{r}
vec <- c(1192, 2960)
vec * 2
```

- 関数(後述)を用いて規則性のあるベクトルを簡単に定義することもできる
  - `seq(a, b, c)`: aからbまで、公差cの等差数列
    - 公差が1の場合は、`a:b`でも代替可能
  - `rep(a, b)`: aをb回繰り返す数列
```{r}
seq(1, 10, 2)
```

## データフレーム

- 各行に観測単位(個人、グループ、都道府県など)、各列に特定の情報を含んだデータ形式
  - 実際にデータ分析を行う際は、csvファイルなどをこの形式で読み込むことでRで扱えるようにする
- 100人の性別、学年、学部が分かるデータフレーム：100行×3列のデータフレームになる

- データフレームは`data.frame`関数、もしくはtibbleパッケージの`tibble`関数で定義する

## データフレーム (cont'd)

```{r, eval=FALSE}
library(tidyverse) # パッケージを起動
```

```{r}
df <- tibble::tibble( # dfというオブジェクトにデータフレームを定義
  faculty = c("econ", "law", "foreign", "lit"), # 各列のデータをベクトル形式で代入
  grade = c(4, 2, 1, 1),
  toeic = c(300, 820, NA, 785) # NA: 該当する値が存在しないことを表す＝無回答など
)
print(df)
```


## リスト

- 値、ベクトル、データフレームなど、何を入れてもいい箱
- `list(要素1, 要素2, ...)`で定義
- 複数のデータフレームに対して同じ操作をしたい場合などに便利

```{r}
listA <- list(data.frame(a = 1:5, b = 11:15, c = 100:104), df)
print(listA)
```

## リスト (cont'd)

```{r}
print(listA[[1]]) # リストの中の一部の要素のみ利用する場合は、[[]]で指定する
```

- あんまり便利さが伝わらなさそうなので分析パートで後述

## 関数

- Rで行う典型的な操作・計算を行う命令
- 操作を実行する対象となる値や、実行にあたって選択可能な様々なオプションを(関数名)(引数1 = ., 引数2 = ., ...)の形で記述
```{r}
log(x = 100, base = 10) # 100の対数、底10で計算
log(x = 100, base = 5) # 底を5に変更
```
- デフォルトで搭載されている関数の他に、便利な関数をまとめて利用可能にする「パッケージ」をインストール・活用することもできる
```{r, eval=FALSE}
install.packages("tidyverse") # tidyverse パッケージをインストール
library(tidyverse) # tidyverse パッケージを有効化：起動したときに毎回実行する
```

## 関数 (cont'd)
- 各関数において使用される引数の名前は決まっており、必要なオプションに対して一つひとつ情報を指定する
  - 引数には数値や文字列を取ったり、ベクトルやデータフレームを取る時もある
- 引数を指定しなければエラーが出るものと、指定しない場合のオプションを自動で選んでくれるものとが存在
- パッケージ名::関数名()でその関数がどのパッケージに属しているかを明示することもできる
- 実行結果のエラー
  - エラー：引数指定の不備などで計算が実行できなかった場合
  - 警告(warning)：引数を自動補完した、計算結果に不備があるなどしたが、とりあえず結果は出た

## 例：図形の描画

- $y = x^2$のグラフの描画、定義域は-5から5
- pchはプロットの形を指定、colはプロットの色

```{r, out.width="47%", fig.align='center'}
graphics::plot(x = -5:5, y = (-5:5)^2, pch = 19, col = "magenta") 
```

# データの操作

- デフォルト/特定のパッケージに含まれるデータの利用
- 外部ファイルからデータを読み込む
- データの概要を把握する：記述統計の表示
- データを整理する
  - 新しい変数を作成する
  - 不要な行を削除する
  - 不要な列を削除する
  - 文字列の処理


## データの取得

- 分析方法が決まったらデータを取得
- ここではRで簡単に利用できるサンプルデータを取得して分析・可視化を行う
- palmerpenguinsパッケージをインストール、penguins_rawデータを使ってみる

```{r, eval=FALSE}
install.packages("palmerpenguins")
```

- パッケージを読み込むとデータセットが利用できるようになる

```{r, eval=FALSE}
library(palmerpenguins)
palmerpenguins::penguins_raw
```

## データを確認
```{r, echo=FALSE, warning=FALSE, out.width="80%"}
library(palmerpenguins)
DT::datatable(
  palmerpenguins::penguins_raw,
  filter = "top",
  options = list(
    pageLength = 3,
    scrollX = T,
    scrollY = T
  )
)
```

## CSVファイルからデータフレームを読み込み

- csv (comma separated values)

## Penguins データの概要

- ペンギンをとっ捕まえて大きさや重さを計測したデータ
- 元論文：[Kristen B. Gorman ,Tony D. Williams, and William R. Fraser (2014)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0090081)
- 論文引用のフォーマット
  - Gorman KB, Williams TD, Fraser WR (2014) Ecological Sexual Dimorphism and Environmental Variability within a Community of Antarctic Penguins (Genus Pygoscelis). PLoS ONE 9(3): e90081. [https://doi.org/10.1371/journal.pone.0090081]
  - "Cite" みたいなボタンを押すと簡単にフォーマットをコピーできることが多いです
- head(データフレーム, 行数)でデータの行頭を表示させることができる

```{r}
head(penguins_raw, 5)
```

# データの概観：可視化

- データを可視化する：ggplot2パッケージの利用

# 分析と結果の表示

- 分析目的の設定
- 最小二乗法
- 最尤法
  - ロジスティック回帰
- 操作変数法

# RMarkdownを用いたレポートの作成

- Markdown形式のドキュメント
  - 数式フォントの利用
- コードブロックの作成
- htmlドキュメントの作成
- Powerpointファイルへの変換
- Wordファイルへの変換
- R Markdownを併用して論文作成・スライド作成の手間を省く

## Markdownとは

- 主にhtml(ウェブサイトなどで利用される形式)を手軽に出力するために考案された言語
- Rの結果出力などに特化した形式：R Markdown
  - ここではR Markdownについて扱う
  - htmlだけでなく、WordやPowerPointなど、使い慣れた形式にも変換可能
- 分析結果をいちいちスクリーンショットしたり、体裁を整えるために出力をやり直したりする必要がなくなる
  - 全てをR Markdownで完結させる必要はないので、例えば図や分析結果の出力をするためのWordファイルを作り、できたものをコピペするなどして使えば微調整も容易

# おまけ：バージョン管理

- 論文執筆・輪読の資料報告は班単位で行うので、スライドや分析結果を複数人で作成・共有する必要がある
- Dropbox, Github, Google Drive などでファイルごと共有しておくと、スライドをくっつけたり各自が修正したものをすり合わせる作業が削減できる、たぶん
- 覚えておいて損はないのでまあ興味があれば訊いて下さい